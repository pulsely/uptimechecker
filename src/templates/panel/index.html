{% extends "designs/coreui.html" %}

{% block title %}
    Uptime Checker Control Panel
{% endblock %}

{% load humanize %}
{% block content %}


    <!-- content -->

    <div class="row" id="app">
        <div class="col-12">
            {% if is_secretkey_insecure %}
                <div class="alert alert-danger">
                    <p>Your Django SECRET_KEY is using the default insecure key. Please generate and use a custom
                        one.</p>
                </div>
            {% endif %}

            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title mb-0"> [[objects.length]] Uptime Records
                            </h4>
                            {#                            <div class="small text-medium-emphasis">January - July 2022</div>#}
                        </div>
                        <div class="btn-toolbar d-none d-md-block" role="toolbar" aria-label="Toolbar with buttons">
                            <button class="btn btn-success btn-sm mr-4 text-white" @click="loadObjects"><i
                                    class="fa-solid fa-rotate-right"></i> Refresh
                            </button>
                            <button class="btn btn-warning text-white btn-sm mr-4" @click="triggerAllhost"><i
                                    class="fa-solid fa-robot"></i> Check all now
                            </button>

                        </div>
                    </div>


                </div>

                <div class="card-body">
                    <table class="table">
                        <thead>
                        <th></th>
                        <th>
                            Website
                        </th>
                        <th>SSL Expiration</th>
                        <th>Previous Exception</th>
                        <th>Status 0</th>
                        <th>Status -1</th>

                        <th>Status -2</th>

                        <th>Status -3</th>

                        <th>Status -4</th>

                        </thead>
                        <tbody>
                        <tr class="tableHoverRow" v-for="object in objects" :key="object.id">
                            <td>
                                <button class="btn btn-info boldWhite btn-sm"
                                        @click="triggerSingleHost($event, object.id)"><i
                                        class="fa-solid fa-robot"></i></button>
                            </td>
                            <td>
                                <span v-show="object.title">
                                    <span>[[object.title]]</span><br/>
                                    <a :href="object.target_website_url" target="_blank"
                                       class="no-underline-link small">[[object.target_website_url]]</a>
                                </span>

                                <span v-show="!object.title">
                                    <a :href="object.target_website_url"
                                       target="_blank" class="no-underline-link">[[object.target_website_url]]</a>
                                </span>
                            </td>
                            <td><span v-if="object.ssl_expire_time">[[unixtime_to_locale(object.ssl_expire_time)]]<br/>
                                <small class="text-muted">{{ r.target_website.ssl_expire_time|timeuntil }}</small></span>
                            </td>
                            <td><span v-if="object.previous_exception && object.previous_exception.time">[[unixtime_to_locale(object.previous_exception.time)]]

                                <br/>
                                <span class="small text-muted">[[object.previous_exception.status_display]]</span>
                            </span>
                            </td>

                            <td v-for="uptime in object.uptimes" :key="end_time">
                                <span :class="buttonClassForStatus(uptime.status)">[[uptime.status_display]]</span>


                            </td>
                        </tr>

                        {% comment %}
                        {% for r in results %}
                            <tr class="tableHoverRow">
                                <td>
                                    <button class="btn btn-info boldWhite btn-sm"
                                            @click="triggerSingleHost($event, '{{ r.target_website.uuid }}')"><i
                                            class="fas fa-redo-alt"></i></button>
                                </td>
                                <td><a href="{{ r.target_website }}">{{ r.target_website }}</a>
                                    {% if r.previous_exception %}
                                    {% endif %}
                                </td>
                                <td>{{ r.target_website.ssl_expire_time }}<br/>
                                    <small class="text-muted">{{ r.target_website.ssl_expire_time|timeuntil }}</small>
                                </td>
                                <td>{{ r.previous_exception.end_time|timesince }}
                                </td>

                                {% for u in r.uptimes %}
                                    <td>
                                        <span class="badge {{ u.badge_color }}">{{ u.status }}</span><br>

                                        <span class="small">{{ u.end_time|timesince }}</span>
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        {% endcomment %}
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block postflight %}
    <script language="JavaScript">

        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = 'X-CSRFToken';

        Vue.mixin({
            delimiters: ['[[', ']]']
        });

        var vm = new Vue({
            el: '#app',
            data: {
                message: "Ready",
                objects: [],
                flag_loading: false,
            },
            methods: {
                unixtime_to_locale(str) {
                    var dt = LuxonDateTime.fromMillis(str * 1000).toFormat('dd LLL, yyyy HH:mm:ss');
                    return dt;
                },

                buttonClassForStatus(label) {
                    if (label == "normal") {
                        return 'd-block btn btn-success btn-sm text-white';
                    } else if (label == "checking") {
                        return 'd-block btn btn-warning btn-sm text-white';
                    } else {
                        return 'd-block btn btn-danger btn-sm text-white';
                    }
                },
                loadObjects() {
                    this.flag_loading = true;
                    const data = {};

                    // trigger the "init" operations on server side
                    axios.post("{% url 'panel:api_uptime_list' %}", data).then((res) => {
                        console.log(res.data)
                        if (res.data && res.data.status) {
                            if (res.data.status == 'okay') {
                                this.objects = res.data.results;
                                //this.paginator = res.data.paginator;

                                this.flag_loading = false;
                            }
                        }
                    }).catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: error,
                        })
                    })
                },
                triggerAllhost: function (event) {

                    const posData = {
                        mode: 'all'
                    };

                    // trigger the "init" operations on server side
                    axios.post("{% url 'panel:api_trigger_refresh' %}", posData).then((response) => {
                        var data = response['data'];

                        if (('status' in data) && (data['status'] == 'okay')) {
                            vm.message = data['message'];
                        }
                        if ('error' in data) {
                            swal("Error", data['error'], "error");
                        }

                    }).catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: error,
                        })
                    })
                },

                triggerSingleHost: function (event, host_id) {

                    const posData = {
                        host_id: host_id,
                        mode: 'single'
                    };

                    // trigger the "init" operations on server side
                    axios.post("{% url 'panel:api_trigger_refresh' %}", posData).then((response) => {
                        var data = response['data'];

                        if (('status' in data) && (data['status'] == 'okay')) {
                            vm.message = data['message'];
                        }
                        if ('error' in data) {
                            swal("Error", data['error'], "error");
                        }

                    }).catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: error,
                        })
                    })
                },
            },
            created() {
                console.log("Ready: " + this.message);
                this.loadObjects();

            }
        });


    </script>

{% endblock %}
